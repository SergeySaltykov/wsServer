<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Web socket client</title>
    <link rel="stylesheet" href="bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="bootstrap/css/bootstrap-theme.css">
    <link rel="stylesheet" href="bootstrap/style.css">
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-6 content">
            <h1>Form of calculations</h1>
            <form role="form" name="calc">
                <div class="form-group">
                    <label for="inputParam1">Param 1</label>
                    <input type="number" class="form-control" id="inputParam1" placeholder="Enter param 1">
                    <p class="help-block">help-block 1</p>
                </div>
                <div class="form-group">
                    <label for="inputParam2">Param 2</label>
                    <input type="number" class="form-control" id="inputParam2" placeholder="Enter param 2">
                    <p class="help-block">help-block 2</p>
                </div>

                <div class="clearfix text-center">
                    <div class="row">
                        <div class="col-md-6 center-block fn">
                            <h3 class="text-info">Actions</h3>
                            <div class="col-xs-4">
                                <input type="button"
                                       name="add"
                                       class="btn btn-default btn-block f-w-b"
                                       value="+"
                                       onclick="getAction(name);"
                                />
                            </div>
                            <div class="col-xs-4">
                                <input type="button"
                                       class="btn btn-default btn-block f-w-b"
                                       value="-"
                                       name="subtraction"
                                       onclick="getAction(name);"
                                />
                            </div>
                            <div class="col-xs-4">
                                <input type="button"
                                       class="btn btn-default btn-block f-w-b"
                                       value="x"
                                       name="multiplication"
                                       onclick="getAction(name);"
                                />
                            </div>
                        </div>
                    </div>
                    <div class="row mt-20">
                        <div class="col-md-6 center-block fn">
                            <div class="col-xs-4">
                                <input type="button"
                                       class="btn btn-default btn-block f-w-b"
                                       value="/"
                                       name="division"
                                       onclick="getAction(name);"
                                />
                            </div>
                            <div class="col-xs-4">
                                <input type="button"
                                       class="btn btn-default btn-block f-w-b"
                                       value="x^n"
                                       name="rate"
                                       onclick="getAction(name);"
                                />
                            </div>
                            <div class="col-xs-4">
                                <input type="button"
                                       class="btn btn-default btn-block f-w-b"
                                       value="ln"
                                       name="log"
                                       onclick="getAction(name);"
                                />
                            </div>
                        </div>
                    </div>
                    <div class="row mt-20">
                        <div class="col-md-6 center-block fn">
                            <div class="col-xs-4">
                                <input type="button"
                                       class="btn btn-default btn-block f-w-b"
                                       value="e^x"
                                       name="exponent"
                                       onclick="getAction(name);"
                                />
                            </div>
                            <div class="col-xs-4">
                                <input type="button"
                                       class="btn btn-default btn-block f-w-b"
                                       value="root"
                                       name="root"
                                       onclick="getAction(name);"
                                />
                            </div>
                            <div class="col-xs-4">
                                <input type="button"
                                       class="btn btn-default btn-block f-w-b"
                                       value="root in degree"
                                       name="rootInN"
                                       onclick="getAction(name);"
                                />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-20">
                    <div class="col-xs-4 center-block fn">
                        <button
                                type="button"
                                class="btn btn-info btn-block bnt-lg text-center"
                                onclick="send();"
                        >
                            Submit
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-4 text-danger mt-20">
                        <div class="form-group">
                            <label for="result">Results</label>
                            <input
                                    type="text"
                                    class="form-control"
                                    id="result"
                                    readonly
                            >
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<br>
<br>
<br>
<div>
</div>
<!-- Server responses get written here -->
<div id="messages" class="text-danger"></div>
<!---->

<script src="jquery/jquery-3.3.1.js"></script>
<script src="bootstrap/js/bootstrap.js"></script>

<!-- Script to utilise the WebSocket -->
<script type="text/javascript">
    let webSocket;
    let messages = document.getElementById("messages");
    let result = document.getElementById("result");

    window.onload = function () {
            // return writeResponse("Connection closed!");
        openSocket();
        writeResponse("Connection open");;
    };

    function openSocket() {
        // Ensures only one connection is open at a time
        if (webSocket !== undefined && webSocket.readyState !== WebSocket.CLOSED) {
            writeResponse("WebSocket is already opened.");
            return;
        }
        // Create a new instance of the websocket
        webSocket = new WebSocket("ws://localhost:8080/compute");

        /**
         * Binds functions to the listeners for the websocket.
         */
        webSocket.onopen = function (event) {
            // For reasons I can't determine, onopen gets called twice
            // and the first time event.data is undefined.
            // Leave a comment if you know the answer.
            if (event.data === undefined)
                return;

            writeResponse(event.data);
        };

        webSocket.onmessage = function (event) {
            writeResponse(event.data);
        };

        webSocket.onclose = function (event) {
            writeResponse("Connection closed");
            localStorage.removeItem("action")
        };
    }

    /**
     * Sends the value of the text input to the server
     */
    function send() {
        // var text = document.getElementById("messageinput").value;
        webSocket.send(getData());
        // clearLocalStorage();
    }

    function closeSocket() {
        webSocket.close();
        clearLocalStorage();
    }

    function writeResponse(text) {
        messages.innerHTML += "<br/>" + text;
    }

</script>
<script>
    function getAction(inputName) {
        localStorage.setItem("action", inputName);
    }

    function getData() {
        const getParam1 = document.getElementById("inputParam1").value;
        const valueParam2 = document.getElementById("inputParam2").value;
        const getParam2 = valueParam2 ? valueParam2 : '1';
        const getAction = localStorage.getItem("action");
        const postData = {
            x: parseInt(getParam1),
            y: parseInt(getParam2),
            action: getAction,
            id: Math.round(Math.random()*1000),
        };

        return JSON.stringify(postData);
    }

    function clearLocalStorage() {
        if (!localStorage["action"]) {
            return null;
        }
        localStorage.removeItem("action");
    }
</script>
</body>
</html>